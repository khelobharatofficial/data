<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>India Map Data Visualiser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- D3 & TopoJSON -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://unpkg.com/topojson-client@3"></script>

  <!-- Export libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f5fb;
      color: #111827;
    }
    h1, h2, h3 { margin: 0 0 0.5rem; }

    .page {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 340px) 1fr;
      gap: 1rem;
    }
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
    }
    .card {
      background: #fff;
      border-radius: 0.8rem;
      padding: 1rem 1.2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }
    input[type="text"], select, textarea {
      width: 100%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.4rem;
      border: 1px solid #cbd5e1;
      font-size: 0.9rem;
      margin-bottom: 0.6rem;
    }
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    .row-inline {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      margin-bottom: 0.5rem;
      flex-wrap: wrap;
    }
    .row-inline select {
      flex: 1;
      margin-bottom: 0;
    }
    .row-inline input[type="color"] {
      width: 45px;
      height: 32px;
      padding: 0;
      border: none;
      background: none;
    }
    button {
      border-radius: 0.4rem;
      border: none;
      padding: 0.5rem 0.9rem;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
      margin-right: 0.4rem;
    }
    button.secondary {
      background: #0f766e;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #export-area {
      background: #ffffff;
      padding: 0.5rem 0.5rem 1rem;
      border-radius: 0.8rem;
    }
    #map-container {
      border-radius: 0.6rem;
      border: 1px solid #e2e8f0;
      background: #f8fafc;
      margin-bottom: 0.6rem;
      min-height: 350px;  /* ensures you see the area even before drawing */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #map-container svg {
      width: 100%;
      height: auto;
    }
    #data-box {
      margin-top: 0.2rem;
      padding: 0.7rem 0.9rem;
      border-radius: 0.6rem;
      background: #f1f5f9;
      border: 1px solid #e2e8f0;
    }
    #data-box h3 {
      margin-top: 0;
      font-size: 1rem;
    }
    #data-box p {
      margin: 0.25rem 0 0;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
    .small-note {
      font-size: 0.8rem;
      color: #555;
      margin-top: -0.2rem;
      margin-bottom: 0.4rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>India Map Data Visualiser</h1>
      <p style="margin:0.3rem 0 0.5rem;">
        Choose states, pick colours, add your data title & description, then export the map as PNG or PDF.
      </p>
    </header>

    <div class="layout">
      <!-- Controls -->
      <section class="card">
        <h2 style="font-size:1.1rem;">Input Panel</h2>

        <label for="mapTitle">Map title</label>
        <input id="mapTitle" type="text" placeholder="e.g. Literacy Rate by State" />

        <label for="numStates">Number of states to colour</label>
        <select id="numStates">
          <option value="0">0</option>
          <option value="1">1</option><option value="2">2</option>
          <option value="3">3</option><option value="4">4</option>
          <option value="5">5</option><option value="6">6</option>
          <option value="7">7</option><option value="8">8</option>
          <option value="9">9</option><option value="10">10</option>
        </select>
        <div class="small-note">Only selected states will be coloured. All others stay white by default.</div>

        <div id="state-selectors"></div>

        <hr style="margin:0.7rem 0; border:none; border-top:1px solid #e2e8f0;" />

        <label for="dataTitle">Title of data</label>
        <input id="dataTitle" type="text" placeholder="e.g. Population Density (2021)" />

        <label for="dataDescription">Data description</label>
        <textarea id="dataDescription" placeholder="Describe what this map shows (one or more sentences)..."></textarea>

        <button id="generateBtn">Generate Map</button>
        <div id="statusMsg" class="small-note"></div>

        <hr style="margin:0.7rem 0; border:none; border-top:1px solid #e2e8f0;" />

        <div>
          <button id="downloadPngBtn" class="secondary" disabled>Download PNG</button>
          <button id="downloadPdfBtn" class="secondary" disabled>Download PDF</button>
          <div class="small-note">Export buttons activate after you generate a map.</div>
        </div>
      </section>

      <!-- Map + data box -->
      <section class="card">
        <h2 style="font-size:1.1rem;">Preview</h2>
        <div id="export-area">
          <div id="map-container">
            <span class="small-note">Map will appear here after you click “Generate Map”.</span>
          </div>
          <div id="data-box">
            <h3 id="data-title-display">Data title will appear here</h3>
            <p id="data-description-display">
              Data description will appear here after you generate the map.
            </p>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    let stateFeatures = [];
    let stateNames = [];
    let stateNameProp = "name";  // detected property name

    const statusMsg = document.getElementById("statusMsg");

    // Utility: detect state name from a feature
    function detectStateNameProp(sampleFeature) {
      if (!sampleFeature) return "id";
      const props = sampleFeature.properties || {};
      if ("ST_NM" in props) return "ST_NM";
      if ("st_nm" in props) return "st_nm";
      if ("STATE_NAME" in props) return "STATE_NAME";
      if ("NAME_1" in props) return "NAME_1";
      return "id";
    }

    function getFeatureName(f) {
      const props = f.properties || {};
      return props[stateNameProp] || f.id || "Unknown";
    }

    // Load TopoJSON
    fetch("india.json")
      .then(res => {
        if (!res.ok) throw new Error("Unable to load india.json");
        return res.json();
      })
      .then(topoData => {
        const objectKeys = Object.keys(topoData.objects || {});
        if (!objectKeys.length) throw new Error("No objects in india.json Topology");
        const mainKey = objectKeys[0];   // take first object automatically
        const geo = topojson.feature(topoData, topoData.objects[mainKey]);

        stateFeatures = geo.features || [];
        if (!stateFeatures.length) throw new Error("No features found in india.json");

        // detect which property actually stores state names
        stateNameProp = detectStateNameProp(stateFeatures[0]);

        stateNames = stateFeatures
          .map(getFeatureName)
          .filter(Boolean)
          .sort((a, b) => a.localeCompare(b));

        // build selectors based on current number
        buildStateSelectors(parseInt(document.getElementById("numStates").value, 10));

        statusMsg.textContent =
          `Map data loaded (${stateFeatures.length} states from "${mainKey}", label property "${stateNameProp}").`;
      })
      .catch(err => {
        console.error(err);
        statusMsg.textContent =
          "Error loading india.json. Check that the file is in the same folder as index.html.";
      });

    function buildStateSelectors(count) {
      const container = document.getElementById("state-selectors");
      container.innerHTML = "";
      for (let i = 0; i < count; i++) {
        const row = document.createElement("div");
        row.className = "row-inline";

        const label = document.createElement("span");
        label.textContent = `State ${i + 1}:`;
        label.style.fontSize = "0.85rem";
        label.style.minWidth = "55px";

        const select = document.createElement("select");
        select.className = "state-select";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.textContent = "-- select state --";
        select.appendChild(defaultOpt);
        stateNames.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });

        const colorInput = document.createElement("input");
        colorInput.type = "color";
        colorInput.value = "#3b82f6";
        colorInput.className = "state-color";

        row.appendChild(label);
        row.appendChild(select);
        row.appendChild(colorInput);
        container.appendChild(row);
      }
    }

    document.getElementById("numStates").addEventListener("change", e => {
      const count = parseInt(e.target.value, 10) || 0;
      buildStateSelectors(count);
    });

    function getStateColourMapping() {
      const mapping = {};
      const selects = document.querySelectorAll(".state-select");
      const colors = document.querySelectorAll(".state-color");
      selects.forEach((sel, idx) => {
        const state = sel.value;
        const color = colors[idx].value || "#000000";
        if (state) mapping[state] = color;
      });
      return mapping;
    }

    function drawMap() {
      if (!stateFeatures.length) {
        alert("Map not loaded yet. Wait a second and try again.");
        return;
      }

      const mapTitle = document.getElementById("mapTitle").value.trim();
      const dataTitle = document.getElementById("dataTitle").value.trim();
      const dataDescription = document.getElementById("dataDescription").value.trim();
      const stateColours = getStateColourMapping();

      document.getElementById("data-title-display").textContent =
        dataTitle || "No data title given";
      document.getElementById("data-description-display").textContent =
        dataDescription || "No data description provided.";

      const width = 650;
      const height = 750;

      const container = d3.select("#map-container");
      container.selectAll("*").remove(); // clear placeholder text & old map

      const svg = container
        .append("svg")
        .attr("viewBox", `0 0 ${width} ${height}`)
        .attr("preserveAspectRatio", "xMidYMid meet");

      if (mapTitle) {
        svg.append("text")
          .attr("x", width / 2)
          .attr("y", 28)
          .attr("text-anchor", "middle")
          .attr("font-size", 20)
          .attr("font-weight", "700")
          .text(mapTitle);
      }

      const mapGroup = svg.append("g")
        .attr("transform", mapTitle ? "translate(0,40)" : "translate(0,10)");

      // light background so you clearly see the area
      mapGroup.append("rect")
        .attr("x", 0)
        .attr("y", 0)
        .attr("width", width)
        .attr("height", height - 60)
        .attr("fill", "#e5e7eb");

      const projection = d3.geoMercator()
        .fitSize([width, height - 60], { type: "FeatureCollection", features: stateFeatures });

      const path = d3.geoPath().projection(projection);

      mapGroup.selectAll("path")
        .data(stateFeatures)
        .enter()
        .append("path")
        .attr("d", path)
        .attr("fill", d => {
          const name = getFeatureName(d);
          return stateColours[name] || "#ffffff";  // white if not selected
        })
        .attr("stroke", "#111827")
        .attr("stroke-width", 0.6);

      document.getElementById("downloadPngBtn").disabled = false;
      document.getElementById("downloadPdfBtn").disabled = false;
    }

    document.getElementById("generateBtn").addEventListener("click", drawMap);

    async function exportAsPNG() {
      const exportArea = document.getElementById("export-area");
      const canvas = await html2canvas(exportArea, { scale: 2 });
      const link = document.createElement("a");
      link.download = "india-map.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
    }

    async function exportAsPDF() {
      const exportArea = document.getElementById("export-area");
      const canvas = await html2canvas(exportArea, { scale: 2 });
      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const pdfWidth = pageWidth - 10;
      const pdfHeight = imgProps.height * pdfWidth / imgProps.width;
      const yOffset = (pageHeight - pdfHeight) / 2 > 0 ? (pageHeight - pdfHeight) / 2 : 5;

      pdf.addImage(imgData, "PNG", 5, yOffset, pdfWidth, pdfHeight);
      pdf.save("india-map.pdf");
    }

    document.getElementById("downloadPngBtn").addEventListener("click", exportAsPNG);
    document.getElementById("downloadPdfBtn").addEventListener("click", exportAsPDF);
  </script>
</body>
</html>
